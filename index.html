<!DOCTYPE html>
<html>
<head>
    <title>BC Traffic Map</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1.0" />
    <!-- Replace YOUR_API_KEY with your actual API key -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCIzypwXHVm4201GULNbcXz3L1fMPEaouE"></script>
</head>
<body>
<h1>BC Traffic Map</h1>
<!-- The div that will hold the map -->
<div id="map" style="width:100%;height:600px;"></div>

<h1>Select an Area</h1>
<select id="areasDropdown">
    <option value="">-- Choose an Area --</option>
</select>

<script>
    // 1. We'll store our map in a global variable so we can manipulate it later
    let map;

    // 2. A lookup of each area ID (drivebc.ca/X) to coordinates
    //    based on your provided lat/lng for each district
    const areaCenters = {
        "drivebc.ca/1":  { lat: 49.2058, lng: -123.0233 }, // Lower Mainland District
        "drivebc.ca/2":  { lat: 48.4611, lng: -123.3787 }, // Vancouver Island District
        "drivebc.ca/3":  { lat: 50.5074, lng: -116.0311 }, // Rocky Mountain District
        "drivebc.ca/4":  { lat: 49.3297, lng: -116.7014 }, // West Kootenay District
        "drivebc.ca/5":  { lat: 51.0002, lng: -118.1955 }, // Okanagan-Shuswap District
        "drivebc.ca/6":  { lat: 50.6718, lng: -120.3241 }, // Thompson-Nicola District
        "drivebc.ca/7":  { lat: 52.9809, lng: -122.4933 }, // Cariboo District
        "drivebc.ca/8":  { lat: 55.7579, lng: -120.2373 }, // Peace District
        "drivebc.ca/9":  { lat: 53.9101, lng: -122.7617 }, // Fort George District
        "drivebc.ca/10": { lat: 54.7814, lng: -127.1661 }, // Bulkley Stikine District
        "drivebc.ca/11": { lat: 54.0552, lng: -128.6526 }  // Skeena District
    };

    // 3. Initialize the Google Map
    function initMap() {
        // Default center near Vancouver
        const mapCenter = { lat: 49.2827, lng: -123.1207 };
        const mapOptions = {
            center: mapCenter,
            zoom: 6
        };

        // Create the map in our global variable
        map = new google.maps.Map(document.getElementById("map"), mapOptions);

        // Load BOTH GeoJSON files (roads)
        loadRoadPolylines("map.geojson");
        loadRoadPolylines("westbay_cypress.geojson");

        // Load events (markers) from Open511
        loadEventsWithIcons();
    }

    // 4. Call initMap when the window loads
    window.onload = initMap;

    // 5. Fetch the areas from the Open511 BC API, requesting JSON format
    fetch("https://api.open511.gov.bc.ca/areas?format=json")
        .then(response => response.json())
        .then(data => {
            const areas = data.areas;
            const dropdown = document.getElementById("areasDropdown");

            areas.forEach(areaItem => {
                const option = document.createElement("option");
                option.value = areaItem.id;         // e.g. "drivebc.ca/1"
                option.textContent = areaItem.name; // e.g. "Lower Mainland District"
                dropdown.appendChild(option);
            });
        })
        .catch(error => {
            console.error("Error fetching areas:", error);
        });

    // 6. Listen for user selection in the dropdown
    document.getElementById("areasDropdown").addEventListener("change", (e) => {
        const selectedAreaId = e.target.value;
        console.log("Selected Area ID:", selectedAreaId);

        // Look up coordinates in our areaCenters dictionary
        const coords = areaCenters[selectedAreaId];
        if (coords) {
            // Re-center the map on the chosen district
            map.setCenter(coords);
            map.setZoom(12);
        } else {
            console.warn("No matching coords found for area ID:", selectedAreaId);
        }
    });

    // 7. Function to load and draw local road polylines from a given GeoJSON file
    function loadRoadPolylines(geojsonFile) {
        fetch(geojsonFile)
            .then(response => response.json())
            .then(geojsonData => {
                console.log("Loaded GeoJSON road data from", geojsonFile);

                // Filter for features that have a 'highway' tag (i.e., actual roads)
                const roadFeatures = geojsonData.features.filter(f => {
                    return f.properties && f.properties.highway;
                });

                // For each road feature, draw a Polyline on the map
                roadFeatures.forEach(feature => {
                    const geom = feature.geometry;
                    if (geom.type === "LineString") {
                        drawPolyline(geom.coordinates);
                    } else if (geom.type === "MultiLineString") {
                        // A MultiLineString can contain multiple coordinate arrays
                        geom.coordinates.forEach(line => {
                            drawPolyline(line);
                        });
                    }
                });
            })
            .catch(err => console.error("Error loading", geojsonFile, err));
    }

    // Helper function to create and display a Polyline on the map
    function drawPolyline(coordsArray) {
        // coordsArray is an array of [longitude, latitude]
        const path = coordsArray.map(coord => {
            return { lat: coord[1], lng: coord[0] };
        });

        const polyline = new google.maps.Polyline({
            path: path,
            strokeColor: "#0000FF",
            strokeWeight: 2,
            map: map
        });

        // Optional: click listener to highlight the road
        polyline.addListener("click", () => {
            polyline.setOptions({ strokeColor: "#FF0000", strokeWeight: 4 });
        });
    }

    // 8. Fetch events from Open511 and place different icons for each event_type
    function loadEventsWithIcons() {
        // Example: only ACTIVE events
        fetch("https://api.open511.gov.bc.ca/events?format=json&status=ACTIVE")
            .then(res => res.json())
            .then(data => {
                if (data.events) {
                    data.events.forEach(event => {
                        placeEventMarkerIfRelevant(event);
                    });
                }
            })
            .catch(err => console.error("Error fetching events:", err));
    }

    // 9. Place a marker for CONSTRUCTION, SPECIAL_EVENT, or INCIDENT (if we have point geometry)
    function placeEventMarkerIfRelevant(event) {
        // Only handle specific types
        if (!["CONSTRUCTION", "SPECIAL_EVENT", "INCIDENT"].includes(event.event_type)) {
            return; // skip other event types
        }

        // We only handle point geometry here
        if (!event.geography || event.geography.type !== "Point") {
            return;
        }

        const coords = event.geography.coordinates; // [lon, lat]
        if (!Array.isArray(coords) || coords.length < 2) {
            return;
        }

        const position = { lat: coords[1], lng: coords[0] };
        let iconUrl;

        // Pick an icon based on the event type
        switch (event.event_type) {
            case "CONSTRUCTION":
                iconUrl = "images/construction.png";
                break;
            case "SPECIAL_EVENT":
                iconUrl = "images/special_event.png";
                break;
            case "INCIDENT":
                iconUrl = "images/incident.png";
                break;
            default:
                // If we get here, do nothing or pick a default icon
                return;
        }

        new google.maps.Marker({
            position,
            map,
            icon: {
                url: iconUrl,
                scaledSize: new google.maps.Size(32, 32)
            },
            title: event.headline || event.event_type || "Open511 Event"
        });
    }
</script>
</body>
</html>




